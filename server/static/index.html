<html>
<head>
  <title></title>
  <script src="https://d3js.org/d3.v5.min.js"></script>
  <style type="text/css">
  text {
    font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
  }
  canvas {
    border: 1px solid black;
  }
  </style>
</head>
<body>
<div id="viz"></div>
<canvas id="neighbour" width="600" height="600"></canvas>

<script type="text/javascript">

const partyColors = {
  "c": "rgb(12, 105, 60)",
  "l": "rgb(17, 107, 255)",
  "kd": "rgb(12, 95, 160)",
  "m": "rgb(87, 190, 234)",
  "mp": "rgb(85, 160, 74)",
  "s": "rgb(235, 33, 58)",
  "sd": "rgb(250, 198, 46)",
  "v": "rgb(216, 44, 39)"
}

function expected(data){
  Array.from(new Set(data.map(x => x.party))).forEach(party => {
    let segregatedViews = data
      .filter(v => v.party === party);
    let amountOfVotes = segregatedViews.length;
    let expectedValues = segregatedViews.reduce((prev, next) => 
      [
        prev[0] + next.x/amountOfVotes,
        prev[1] + next.y/amountOfVotes
      ], [0,0]);

    let variance = segregatedViews.reduce((prev, next) => 
    [
      prev[0] + Math.pow(next.x - expectedValues[0], 2)/amountOfVotes,
      prev[1] + Math.pow(next.y - expectedValues[1], 2)/amountOfVotes
    ], [0,0]);

    let standardDeviation = [Math.sqrt(variance[0]), Math.sqrt(variance[1])];

    SVG.append("ellipse")
      .attr("cx", expectedValues[0]*SIZE/2 + SIZE/2)
      .attr("cy", expectedValues[1]*SIZE/2 + SIZE/2)
      .attr("rx", standardDeviation[0]*SIZE/2)
      .attr("ry", standardDeviation[1]*SIZE/2)
      .attr("fill", partyColors[party])
      .attr("opacity", 0.1)
  })
  
}

const SIZE = 600;

let lines = [...Array(11).keys()];

let SVG = d3.select("#viz")
  .append("svg")
  .attr("width", SIZE)
  .attr("height", SIZE)
  .style("background-color", "#ffc");

SVG.selectAll(".horizontal")
  .data(lines)
  .enter().append("line")
  .attr("x1", 0)
  .attr("x2", SIZE)
  .attr("y1", (d, i) => SIZE/10*i)
  .attr("y2", (d, i) => SIZE/10*i)
  .style("stroke", d => d === 5 ? "#222" : "#888")
  .style("stroke-width", d => d === 5 ? 2 : 1);

SVG.selectAll(".horizontal")
  .data(lines)
  .enter().append("line")
  .attr("y1", 0)
  .attr("y2", SIZE)
  .attr("x1", (d, i) => SIZE/10*i)
  .attr("x2", (d, i) => SIZE/10*i)
  .style("stroke", d => d === 5 ? "#222" : "#888")
  .style("stroke-width", d => d === 5 ? 2 : 1);

SVG.append("text")
  .attr("x", SIZE/2 + 5)
  .attr("y", 20)
  .text("GAL");

SVG.append("text")
  .attr("x", SIZE/2 + 5)
  .attr("y", SIZE - 10)
  .text("TAN")

SVG.append("text")
  .attr("x", 10)
  .attr("y", SIZE/2 - 10)
  .text("V")

SVG.append("text")
  .attr("x", SIZE - 20)
  .attr("y", SIZE/2 - 10)
  .text("H")

let votes;


fetch("https://galtanapi.aiman.space/results")
  .then(data => data.json())
  .then(data => {
    let views = data
        .map(answer => answer.political_views)

    let aggregatedViews = views
      .reduce((prev, next) => prev.concat(Object.entries(next)), [])
      .map(d => (
        { party: d[0],
          x: d[1].right_left,
          y: d[1].gal_tan
        })
      )

    expected(aggregatedViews)

    function hideVotes(c) {
      d3.selectAll(`.votes:not(.${c.party})`).transition()
        .duration(200)
        .attr("opacity", 0.2)
    }

    function reverseHideVotes(c) {
      d3.selectAll(`.votes`).transition()
        .duration(200)
        .attr("opacity", 1)
    }

    votes = SVG.selectAll(".votes")
      .data(aggregatedViews)
      .enter().append("circle")
      .attr("r", 4)
      .attr("cx", c => c.x*SIZE/2 + SIZE/2)
      .attr("cy", c => c.y*SIZE/2 + SIZE/2)
      .attr("fill", c => partyColors[c.party])
      .attr("class", c => c.party + " votes")
      .on("mouseover", hideVotes)
      .on("mouseout", reverseHideVotes)

  })

let neighbour = document.querySelector("#neighbour");

let ctx = neighbour.getContext("2d");

fetch("https://galtanapi.aiman.space/results/k/5")
  .then(data => data.json())
  .then(data => {
    data.forEach((d, y) => {
      d.forEach((p, x) => {
        ctx.fillStyle = partyColors[p];
        ctx.fillRect(x,y,1,1)
      })
    })
  })






</script>
</body>
</html>